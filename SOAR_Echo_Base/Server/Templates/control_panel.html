<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Control Panel</title>
		<!-- Link to the Orbitron font from Google Fonts -->
		<link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet" />
		<style>
			body {
			    font-family: 'Orbitron', sans-serif;
				margin: 0px;
				color: black;
			}
			header {
				background: linear-gradient(135deg, rgba(0,103,71,1) 0%, rgba(255,255,255,1) 81%);
				/* background: linear-gradient(135deg, rgba(0,103,71,1) 0%, rgba(207,196,147,1) 81%); */
			    /* background: linear-gradient(to right, #003300, black); */
				display: flex;
				flex-direction: column;
				justify-content: center;
				padding: 1em;
				color: white;

			}
			.title{
			    /* color: white; */
				margin: 0px;
			}
			.GPS{
			    display: flex;
			    flex-direction: column;
			}
			.chart_holder {
				display: grid;
				grid-template-columns: auto auto;
				grid-template-rows: auto;
				column-gap: 1.5em;
				row-gap: 2em;
				/* border: 1px solid red; */
			}
			.chart_formatter {
				width: auto;
				height: auto;
				border: 1px solid #CFC493;
			}
			#left_column {
				display: flex;
				flex-direction: column;
				/* justify-content: center; */
				flex-wrap: wrap;
				margin-left: 1em;
				/* border: 1px solid black; */
				padding-left: 0.5em;
				padding-right: 0.5em;
				background-color: white;
				margin-right: 0.5em;
				height: fit-content;
				flex-grow: 1;
			}
			/* #main_canvas {
				This is not used because it doesn't want to move
				when told to with margin
			} */
			#main_holder {
				display: flex;
				flex-direction: row;
				justify-content: space-between;
			}
			#right_column {
				display: inline-block;
				overflow: scroll;
				max-height: 800px;
				max-width: 1000px;
				border: 1px solid white;
				margin-right: 3em;
			}

			/* ---------------------------------------------------------------------------*/
			/* Toggle Switch from https://uiverse.io/Galahhad/heavy-dog-14 */
			/* switch settings ðŸ‘‡ */
			.ui-switch {
			/* switch */
			--switch-bg: rgb(135, 150, 165);
			--switch-width: 48px;
			--switch-height: 20px;
			/* circle */
			--circle-diameter: 32px;
			--circle-bg: rgb(0, 56, 146);
			--circle-inset: calc((var(--circle-diameter) - var(--switch-height)) / 2);
			}
			.ui-switch input {
			display: none;
			}
			.slider {
			-webkit-appearance: none;
			-moz-appearance: none;
			appearance: none;
			width: var(--switch-width);
			height: var(--switch-height);
			background: var(--switch-bg);
			border-radius: 999px;
			position: relative;
			cursor: pointer;
			}
			.slider .circle {
			top: calc(var(--circle-inset) * -1);
			left: 0;
			width: var(--circle-diameter);
			height: var(--circle-diameter);
			position: absolute;
			background: var(--circle-bg);
			border-radius: inherit;
			background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjAiIHdpZHRoPSIyMCIgdmlld0JveD0iMCAwIDIwIDIwIj4KICAgIDxwYXRoIGZpbGw9IiNmZmYiCiAgICAgICAgZD0iTTkuMzA1IDEuNjY3VjMuNzVoMS4zODlWMS42NjdoLTEuMzl6bS00LjcwNyAxLjk1bC0uOTgyLjk4Mkw1LjA5IDYuMDcybC45ODItLjk4Mi0xLjQ3My0xLjQ3M3ptMTAuODAyIDBMMTMuOTI3IDUuMDlsLjk4Mi45ODIgMS40NzMtMS40NzMtLjk4Mi0uOTgyek0xMCA1LjEzOWE0Ljg3MiA0Ljg3MiAwIDAwLTQuODYyIDQuODZBNC44NzIgNC44NzIgMCAwMDEwIDE0Ljg2MiA0Ljg3MiA0Ljg3MiAwIDAwMTQuODYgMTAgNC44NzIgNC44NzIgMCAwMDEwIDUuMTM5em0wIDEuMzg5QTMuNDYyIDMuNDYyIDAgMDExMy40NzEgMTBhMy40NjIgMy40NjIgMCAwMS0zLjQ3MyAzLjQ3MkEzLjQ2MiAzLjQ2MiAwIDAxNi41MjcgMTAgMy40NjIgMy40NjIgMCAwMTEwIDYuNTI4ek0xLjY2NSA5LjMwNXYxLjM5aDIuMDgzdi0xLjM5SDEuNjY2em0xNC41ODMgMHYxLjM5aDIuMDg0di0xLjM5aC0yLjA4NHpNNS4wOSAxMy45MjhMMy42MTYgMTUuNGwuOTgyLjk4MiAxLjQ3My0xLjQ3My0uOTgyLS45ODJ6bTkuODIgMGwtLjk4Mi45ODIgMS40NzMgMS40NzMuOTgyLS45ODItMS40NzMtMS40NzN6TTkuMzA1IDE2LjI1djIuMDgzaDEuMzg5VjE2LjI1aC0xLjM5eiIgLz4KPC9zdmc+");
			background-repeat: no-repeat;
			background-position: center center;
			-webkit-transition: left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms, -webkit-transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
			-o-transition: left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms, transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
			transition: left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms, transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms, -webkit-transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
			display: -webkit-box;
			display: -ms-flexbox;
			display: flex;
			-webkit-box-align: center;
			-ms-flex-align: center;
			align-items: center;
			-webkit-box-pack: center;
			-ms-flex-pack: center;
			justify-content: center;
			box-shadow: 0px 2px 1px -1px rgba(0,0,0,0.2), 0px 1px 1px 0px rgba(0,0,0,0.14), 0px 1px 3px 0px rgba(0,0,0,0.12);
			;
			}
			.slider .circle::before {
			content: "";
			position: absolute;
			width: 100%;
			height: 100%;
			background: rgba(255, 255, 255, 0.75);
			border-radius: inherit;
			-webkit-transition: all 500ms;
			-o-transition: all 500ms;
			transition: all 500ms;
			opacity: 0;
			}
			/* actions */
			.ui-switch input:checked+.slider .circle {
			left: calc(100% - var(--circle-diameter));
			background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjAiIHdpZHRoPSIyMCIgdmlld0JveD0iMCAwIDIwIDIwIj4KICAgIDxwYXRoIGZpbGw9IiNmZmYiCiAgICAgICAgZD0iTTQuMiAyLjVsLS43IDEuOC0xLjguNyAxLjguNy43IDEuOC42LTEuOEw2LjcgNWwtMS45LS43LS42LTEuOHptMTUgOC4zYTYuNyA2LjcgMCAxMS02LjYtNi42IDUuOCA1LjggMCAwMDYuNiA2LjZ6IiAvPgo8L3N2Zz4=");
			}
			.ui-switch input:active+.slider .circle::before {
			-webkit-transition: 0s;
			-o-transition: 0s;
			transition: 0s;
			opacity: 1;
			width: 0;
			height: 0;
			}
			/* ---------------------------------------------------------------------------*/
		</style>
	</head>
	<body style="background-color: #CAD2D8;">
		<header>
			<!-- <br /> -->
			<h1 class="title">SOAR Echo Base</h1>
			<!-- <br /> -->
		</header>
		<br />
		<br />
		<br />
		<div id="main_holder">
			<div id="left_column">
				<!-- GPS Information and Test Input Values Holder -->
				<div class="GPS">
					<h2 class="text">GPS Coordinates</h2>
					<div>
						<h3 style="margin-top: 0px;">Current Location of Payload</h3>
						<p>Note: Latitude is formatted as DDMM.MMMM, and Longitude as DDDMM.MMMM</p>
						<p id="side_display_lat">Latitude:</p>
						<p id="side_display_long">Longitude:</p>
					</div>

					<div>
						<h3 style="margin-top: 0px;">Inputs</h3>
						<p>These inputs are used for testing function parameters</p>
						<input type="text" id="live_nmea" style="width: 500px;" />
						<br />
						<button id="dummy_plot">Plot</button>
					</div>

					<div id="button_holder">
						<button id="gps_start">GPS Start</button>
						<button id="random_cmd">random_cmd</button>
						<label class="ui-switch" id="theme_toggle">
							<input type="checkbox" />
							<div class="slider">
								<div class="circle"></div>
							</div>
						</label>
					</div>
				</div>

				<!-- Charts if necessary -->
				<div class="chart_holder">
					<div class="chart_formatter">
						<h3 class="title">Chart 1</h3>
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
					</div>

					<div class="chart_formatter">
						<h3 class="title">Chart 2</h3>
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
					</div>

					<div class="chart_formatter">
						<h3 class="title">Chart 3</h3>
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
					</div>

					<div class="chart_formatter">
						<h3 class="title">Chart 4</h3>
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
					</div>

					<div class="chart_formatter">
						<h3 class="title">Chart 5</h3>
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
					</div>

					<div class="chart_formatter">
						<h3 class="title">Chart 6</h3>
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
					</div>

					<div class="chart_formatter">
						<h3 class="title">Chart 7</h3>
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
						<br />
					</div>
				</div>
			</div>

			<!-- Canvas Element for the Map -->
			<div id="right_column">
				<!-- <img src="Resized Varn-Ranch-Map.png" style="z-index: -1;" /> -->
				<canvas id="main_canvas" width="1505" height="1505"></canvas>
			</div>
		</div>
		<br />
		<br />
		<br />
		<br />
		<br />
		<br />
		<br />
		<br />
		<br />
		<br />
		<br />
		<br />
		<br />
		<br />
		<br />
		<script>
			//Sets up the map after page load
			function draw() {
			     const canvas = document.getElementById("main_canvas");
			     if (canvas.getContext) {
			       const ctx = canvas.getContext("2d");
					//Insert code to draw here
					ctx.translate(602.5, 752.5);

					//Notes:
					//The .png is 1505x1505 pixels
					//On the map taken from https://apps.nationalmap.gov/viewer/ , when going to 28Â°05'30.9"N 82Â°10'10.3"W coordinates for Varn Ranch
					//And zooming out to the maximum possible zoom the website allows you to see while still showing images, it will show in the
					//bottom left corner that the scale factor is this length representing 600 feet. I used Windows PowerToys Screen Ruler tool to
					//measure the length of that and got the number 82 pixels = 600 feet. Applying that to this canvas element, which is 1505px x 1505px
					//Doing 600/82 and you get 1px = 300/41 ft, or approximately 7.317 ft.
					//This calculation implies that the map covers an area of 11012.195ft x 11012.195ft, which is more than sufficient for NSL.

					const background = new Image();
					background.src = "Resized Varn-Ranch-Map.png";
					background.addEventListener("load", () => {
					ctx.drawImage(background, -602.5, -752.5);
					ctx.fillStyle = "rgb(255,0,0)";
					ctx.strokeStyle = "rgb(255,0,0)";
					ctx.fillRect(0,0,10,10);
					ctx.stroke();

					})
			     }
			   };
			window.addEventListener("load", draw);

			//Processes and plots the data on the map
			function plot(nmea_sentence){
				//Grab the important information from the NMEA sentence
				let time = nmea_sentence.slice(7,13);
				let lat = nmea_sentence.slice(20,29); // Y Value
				let long = nmea_sentence.slice(32, 42); // X Value
				let minuteslat = lat.slice(2,9);
				let minuteslong = long.slice(3,10);

				//Latitude-----------------------------------------------------------------------------------------------------------------
				/*Latitude Formula explanation
				1 min = 1 nm = 6076.12ft
				X min = Y ft
				1/(1/X) = X
				6076.12/(1/X) = Y
				so 6076.12 * X = Y
				This will give us Y, the distance in feet.

				We need to convert this to pixels.
				To do this, we use the previously found calculations that determined that
				1 px = 300/41 ft
				Thus,
				Y / (300/41) = Z pixels
				*/
				// lat = (lat - 2805.5864) * 300;
				let real_lat = (6076.12 * (minuteslat - 5.5864)) / (300/41);
				Math.fround(lat);

				//Longitude----------------------------------------------------------------------------------------------------------------
				/*Longitude Formula Explanation
				The distance between degrees of latitude remains consistent, but due to the way that longitudal lines converge as they
				get closer to the poles, the distances between lines of longitude vary. This can be accounted for by the following formula:

				1 min = cos(latitude) nm = cos(latitude)

				By this logic, at 0 degrees latitude, the distance between longitudinal lines will be 1 nm for every degree. This will
				complement the fact that at in latitude, every minute is 1 nm.

				1 min = cos(latitude) nm
				First, convert nm to ft
				1 nm = 6076.12 ft
				A nm = B ft
				6076.12 * A = Y ft
				So 1 min = 6076.12 * cos(latitude)

				X min = Y ft
				6076.12 * cos(latitude) * X min = Y ft

				We need to convert this to pixels.
				To do this, we use the previously found calculations that determined that
				1 px = 300/41 ft
				Thus,
				Y / (300/41) = Z pixels
				*/
				// long = (long - 8210.5440) * 300;
				let real_long = (6076.12 * (Math.cos(real_lat)) * (minuteslong - 10.5440)) / (300/41);
				Math.fround(long);
				//-------------------------------------------------------------------------------------------------------------------------

				console.log("Old Scale: Time: ", time, "Lat: ", lat, "Long: ", long);
				console.log("True Scale: Time: ", time, "Lat: ", real_lat, "Long: ", real_long);

				/*Here is a sample NMEA sentence from Varn Ranch that can be used to test functioning
				$GNRMC,025859.000,A,2805.5864,N,08210.5439,W,0.10,174.77,181123,,,A*68
				NOTE: The GPS gives data in the following format:
				Latitude: DDMM.MMMM (D representing Degrees, and M for minutes)
				Longitude: DDDMM.MMMM (D representing Degrees, and M for minutes)
				Understand that each Degree has 60 Minutes, and each Minute has 60 Seconds*/


				//Display on the coordinate the received information:
				let side_display_lat = document.getElementById("side_display_lat");
				let side_lat_info = document.createTextNode(lat);
				side_display_lat.appendChild(side_lat_info);

				let side_display_long = document.getElementById("side_display_long");
				let side_long_info = document.createTextNode(long)
				side_display_long.appendChild(side_long_info);


				//Map the received information
				let old_time = "0";
				const canvas = document.getElementById("main_canvas");
				if (canvas.getContext) {
					const ctx = canvas.getContext("2d");
					// console.log("Time: ", time, "Lat: ", lat, "Long: ", long);
					ctx.fillStyle = "rgb(0,255,0)";
					ctx.fillRect(real_long, real_lat,10,10);
					time = old_time;
					ctx.fillStyle = "rgb(0,255,0)";

					if (time != old_time) {
						ctx.fillRect(lat,long,10,10);
						time = old_time;
				}

				}




			};

			//Code that will change the themes
			document.getElementById("theme_toggle").addEventListener("click", theme_changer());

			function theme_changer(theme, bkg, bkg_color, header_style) {
				console.log(document.getElementById("theme_toggle").value);
			};

			//Code that plots values from a front-end input NMEA sentence
			document.getElementById("dummy_plot").addEventListener("click", () => {
				// let time = document.getElementById("dummy_time").value;
				// let lat = document.getElementById("dummy_lat").value;
				// let long = document.getElementById("dummy_long").value;

				let nmea = document.getElementById("live_nmea").value;
				// plot(time, lat, long);
				plot(nmea);
			})


			//BACK END CODE BEGINS --------------------------------------------------------------------------------------------------------
			//Script to connect with the server
			var server = 'http://' + document.domain + ':' + location.port;

			//Below script to handle GPS Start button press
			var generateBtn = document.getElementById('gps_start');
			generateBtn.addEventListener('click', get_response);
			function get_response() {
			    const fetch_promise=fetch(server+'/gps_start');
			    fetch_promise
			    .then((response)=>{
			        if(!response.ok){
			            throw new Error('HTTP error: ${response.status}');
			        }
			        return response.text();
			    })
			    .then((text)=>{
			        // console.log(text);
					plot(text);
			    })
			}


			var random_cmd = document.getElementById('random_cmd');
			random_cmd.addEventListener('click', send_random);
			function send_random() {
			    const fetch_promise=fetch(server+'/random_cmd');
			    fetch_promise
			    .then((response)=>{
			        if(!response.ok){
			            throw new Error('HTTP error: ${response.status}');
			        }
			        return response.text();
			    })
			    .then((text)=>{
			        console.log(text);
			    })
			}
		</script>
	</body>
</html>
